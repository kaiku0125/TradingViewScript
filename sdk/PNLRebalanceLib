//@version=5

library(title = "PNLRebalanceLib", overlay =  true) 

var string DISPLAY_NONE = "--"
var string ICON_ROCKET = " 🚀"
var string ICON_UP_50 = " 🤑"
var string ICON_UP_20 = " 😀"
var string ICON_UP = " 🙂"
var string ICON_DOWN = " 🙁"
var string ICON_DOWN_20 = " 😨"
var string ICON_DOWN_50 = " 😱"
var string ICON_GG = " 🈹"
var VERSION_NAME = "v2.0"

var color DF_TEXT_COLOR = color.rgb(255, 255, 204) 
var color DF_CELL_COLOR = color.rgb(77, 77, 77)


export calDefault(float currentPrice, float position, float cost, float totalAssets) =>
    remain = currentPrice * position
    pnl = remain - cost
    pnlPercent = pnl / cost
    nowRatio = remain / totalAssets
    [remain, pnl, pnlPercent, nowRatio]
    
export calByRemain(float remain, float cost, float totalAssets) =>
    pnl = remain - cost
    pnlPercent = pnl / cost
    nowRatio = remain / totalAssets
    [remain, pnl, pnlPercent, nowRatio]

export ratioStateJudge(float ratio, color bullColor) =>
    string outputIcon = if ratio >= 0
        if math.abs(ratio) >= 100
            ICON_ROCKET
        else if math.abs(ratio) < 100 and math.abs(ratio) >= 50   
            ICON_UP_50
        else if math.abs(ratio) < 50 and math.abs(ratio) >= 20
            ICON_UP_20
        else if math.abs(ratio) < 20 and math.abs(ratio) > 0  
            ICON_UP
        else 
            DISPLAY_NONE   
    else 
        if math.abs(ratio) >= 80
            ICON_GG
        else if math.abs(ratio) < 80 and math.abs(ratio) >= 50
            ICON_DOWN_50
        else if math.abs(ratio) < 50 and math.abs(ratio) >= 20
            ICON_DOWN_20
        else 
            ICON_DOWN

    color outputColor = if ratio > 0
        bullColor
    else if ratio < 0
        color.red
    else
        DF_TEXT_COLOR
    [outputIcon, outputColor]

export DISPLAY_NONE() =>
    DISPLAY_NONE

export getSDKVersion() =>
    VERSION_NAME